#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include "SparkFun_SCD30_Arduino_Library.h"

// ----------------- SGP40 -----------------
#include "Adafruit_SGP40.h"
#include "VOCGasIndexAlgorithm.h"

// ----------------- Wi-Fi -----------------
const char* ssid = "tumoTeam";
const char* password = "hello2team";

// ----------------- API -------------------
const char* apiEndpoint = "https://eog7lgbrtf.execute-api.eu-central-1.amazonaws.com/default/fromEspToTimestream";
const char* deviceId    = "ESP32_01";

// ----------------- BME280 ----------------
Adafruit_BME280 bme;
#define I2C_SDA 21
#define I2C_SCL 22

// ----------------- SCD30 -----------------
SCD30 scd30;

// ----------------- SPS30 -----------------
#define SPS30_ADDR 0x69
#define CMD_START_MEASUREMENT  0x0010
#define CMD_READ_DATA_READY    0x0202
#define CMD_READ_MEASUREMENT   0x0300

// ------------ SGP40 ------------
Adafruit_SGP40 sgp40;
VOCGasIndexAlgorithm voc_algorithm;   // created ONCE (no reassignment allowed)

// CRC-8 for SPS30
uint8_t sps30_crc8(const uint8_t *buf, uint8_t len) {
  uint8_t crc = 0xFF;
  for (uint8_t i = 0; i < len; i++) {
    crc ^= buf[i];
    for (uint8_t b = 0; b < 8; b++) {
      crc = (crc & 0x80) ? (crc << 1) ^ 0x31 : (crc << 1);
    }
  }
  return crc;
}

void i2cWrite16(uint16_t cmd) {
  Wire.beginTransmission(SPS30_ADDR);
  Wire.write(cmd >> 8);
  Wire.write(cmd & 0xFF);
  Wire.endTransmission();
}

bool i2cReadBytes(uint8_t *buf, size_t len) {
  Wire.requestFrom(SPS30_ADDR, len);
  size_t idx = 0;
  while (Wire.available() && idx < len) {
    buf[idx++] = Wire.read();
  }
  return (idx == len);
}

void startMeasurement() {
  Wire.beginTransmission(SPS30_ADDR);
  Wire.write(CMD_START_MEASUREMENT >> 8);
  Wire.write(CMD_START_MEASUREMENT & 0xFF);

  Wire.write(0x03);  // float output format
  Wire.write(0x00);

  uint8_t crc = sps30_crc8((uint8_t[]){0x03, 0x00}, 2);
  Wire.write(crc);

  Wire.endTransmission();
  delay(3000);
}

bool dataReady() {
  i2cWrite16(CMD_READ_DATA_READY);
  uint8_t buf[3];
  if (!i2cReadBytes(buf, 3)) return false;
  return buf[1] == 0x01;
}

float parseFloatFromData(const uint8_t *packet) {
  uint8_t raw[4];
  raw[0] = packet[0];
  raw[1] = packet[1];
  raw[2] = packet[3];
  raw[3] = packet[4];

  uint32_t val =
    ((uint32_t)raw[0] << 24) |
    ((uint32_t)raw[1] << 16) |
    ((uint32_t)raw[2] << 8 ) |
    (uint32_t)raw[3];

  float f;
  memcpy(&f, &val, sizeof(f));
  return f;
}

void readSPS30(float *outVals, int count) {
  i2cWrite16(CMD_READ_MEASUREMENT);

  const int bytesPerFloat = 6;
  const int totalBytes = count * bytesPerFloat;

  uint8_t buf[60];
  if (!i2cReadBytes(buf, totalBytes)) return;

  for (int i = 0; i < count; i++) {
    const uint8_t *p = buf + i * bytesPerFloat;

    if (sps30_crc8(p, 2) != p[2] ||
        sps30_crc8(p + 3, 2) != p[5]) {
      outVals[i] = NAN;
    } else {
      outVals[i] = parseFloatFromData(p);
    }
  }
}
// ----------------- Wi-Fi Connection -----------------
void connectWiFi() {
  if (WiFi.status() == WL_CONNECTED) return;

  WiFi.begin(ssid, password);
  Serial.print("Connecting to Wi-Fi");

  int retry = 0;
  while (WiFi.status() != WL_CONNECTED && retry < 20) {
    delay(500);
    Serial.print(".");
    retry++;
  }
if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWi-Fi connected!");
    Serial.print("IP: "); Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nFailed to connect to Wi-Fi");
  }
}

// ----------------- SETUP -----------------
void setup() {
  Serial.begin(115200);
  delay(1000);
  Wire.begin(I2C_SDA, I2C_SCL);

  // BME280
  if (!bme.begin(0x76) && !bme.begin(0x77)) {
    Serial.println("BME280 not found!");
    while (1) delay(10);
  }
  Serial.println("BME280 initialized");

  // SCD30
  if (!scd30.begin()) {
    Serial.println("SCD30 not found!");
  } else {
    scd30.setMeasurementInterval(2);
    scd30.setAutoSelfCalibration(true);
    Serial.println("SCD30 initialized");
  }

  // SPS30
  Serial.println("Starting SPS30â€¦");
  startMeasurement();

  // ----- SGP40 -----
  if (!sgp40.begin()) {
    Serial.println("SGP40 not found!");
  } else {
    Serial.println("SGP40 initialized");
  }

  connectWiFi();
}

// ----------------- LOOP -----------------
void loop() {
  if (WiFi.status() != WL_CONNECTED) connectWiFi();

  // ----- BME280 -----
  float temperature = bme.readTemperature();
  float pressure    = bme.readPressure() / 100.0F;
  float humidity    = bme.readHumidity();
  float altitude    = bme.readAltitude(1013.25);

  // ----- SCD30 -----
  float co2ppm = 0.0;
  if (scd30.dataAvailable()) {
    co2ppm = scd30.getCO2();
  }

  // ----- SPS30 -----
  float pm[10] = {0};
  if (dataReady()) {
    readSPS30(pm, 10);
  }

  // ----- SGP40 (TVOC index) -----
  uint16_t sgp40_raw = sgp40.measureRaw(temperature, humidity);
  int32_t tvoc_index = voc_algorithm.process(sgp40_raw);

  Serial.print("SGP40 raw: ");
  Serial.print(sgp40_raw);
  Serial.print(" | TVOC index: ");
  Serial.println(tvoc_index);

  // ----- JSON -----
  String payload = "{";
  payload += "\"temperature\":" + String(temperature, 2) + ",";
  payload += "\"pressure\":"    + String(pressure,    2) + ",";
  payload += "\"humidity\":"    + String(humidity,    2) + ",";
  payload += "\"altitude\":"    + String(altitude,    2) + ",";
  payload += "\"co2ppm\":"      + String(co2ppm,      2) + ",";

  // SPS30
  payload += "\"pm1_0\":"       + String(pm[0], 2) + ",";
  payload += "\"pm2_5\":"       + String(pm[1], 2) + ",";
  payload += "\"pm4_0\":"       + String(pm[2], 2) + ",";
  payload += "\"pm10\":"        + String(pm[3], 2) + ",";
  payload += "\"nc0_5\":"       + String(pm[4], 2) + ",";
  payload += "\"nc1_0\":"       + String(pm[5], 2) + ",";
  payload += "\"nc2_5\":"       + String(pm[6], 2) + ",";
  payload += "\"nc4_0\":"       + String(pm[7], 2) + ",";
  payload += "\"nc10\":"        + String(pm[8], 2) + ",";
  payload += "\"typical_size\":"+ String(pm[9], 2) + ",";

  // SGP40
  payload += "\"sgp40_raw\":"   + String(sgp40_raw) + ",";
  payload += "\"tvoc_index\":"  + String(tvoc_index) + ",";

  payload += "\"deviceId\":\""  + String(deviceId) + "\"";
  payload += "}";

  Serial.println("Sending payload:");
  Serial.println(payload);

  // ----- POST -----
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(apiEndpoint);
    http.addHeader("Content-Type", "application/json");

    int httpCode = http.POST(payload.c_str());

    if (httpCode > 0) {
      Serial.print("HTTP Response code: "); Serial.println(httpCode);
      Serial.println(http.getString());
    } else {
      Serial.print("HTTP POST failed: "); Serial.println(httpCode);
    }
    http.end();
  }

  delay(600000); // every 10 minutes
}
